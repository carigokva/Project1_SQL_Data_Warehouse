-- Data Quality Check of bronze.erp_cust_az12
-- inspect all columns, identify what must be unique, what value must be standardized
-- identify primary key, see if it matches foreign key from referencing table.
-- identify if there are trailing spaces on text type columns
-- create script to fix issue per column

SELECT * FROM bronze.erp_cust_az12 LIMIT 10;

-- =====================================================================================================================
-- cid
-- no duplicate cid value
-- check for NULLs or blanks
-- all cid must be in cst_key column of silver.crm_cust_info
-- cid format must be the same with cst_key from silver.crm_cust_info table
-- no trailing space

SELECT cid, COUNT(*)
FROM bronze.erp_cust_az12
GROUP BY cid
HAVING COUNT(*) > 1;

SELECT cid
FROM bronze.erp_cust_az12
WHERE cid IS NULL OR cid = '';

SELECT cid
FROM bronze.erp_cust_az12
WHERE TRIM(cid) != cid;

SELECT cst_key FROM silver.crm_cust_info;
SELECT cid FROM bronze.erp_cust_az12;

--ISSUES:
-- cid value have leading characters causing mismatch to cst_key column of silver.crm_cust_info
-- cid = NASAW00011000, cst_key = AW00011000

--ACTION::
-- derive cid_new = AW00011000 from cid = NASAW00011000 using SUBSTR

--result of this query shows that there are values that do not start with NAS
--use CASE statement to retain value if first 3 characters = AW0
SELECT DISTINCT SUBSTRING(cid FROM 1 FOR 3)
FROM bronze.erp_cust_az12;

--script to see the number of rows with 'AW0' and 'NAS' as first 3 characters
SELECT cid
FROM bronze.erp_cust_az12
WHERE cid LIKE 'AW0%'


SELECT cid
FROM bronze.erp_cust_az12
WHERE SUBSTRING(cid FROM 1 FOR 3) = 'NAS'
--                  both script result to same result, but use LIKE function.
SELECT cid
FROM bronze.erp_cust_az12
WHERE cid LIKE 'NAS%';

--script to omit the first 3 characters if it starts with 'NAS'
SELECT
	cid,
	CASE
		WHEN TRIM(cid) LIKE 'NAS%' THEN SUBSTRING(TRIM(cid) FROM 4)
		WHEN TRIM(cid) LIKE 'AW0%' THEN TRIM(cid)
		ELSE NULL
	END AS cid_new --case statement to be used as the replacement cid
FROM bronze.erp_cust_az12
WHERE cid LIKE 'NAS%';

--script to test new query
--there should be 0 results to indicate that all cid have a match in cst_key from cust_info table
WITH cte1 AS(
			SELECT
				CASE
					WHEN TRIM(cid) LIKE 'NAS%' THEN SUBSTRING(TRIM(cid) FROM 4)
					WHEN TRIM(cid) LIKE 'AW0%' THEN TRIM(cid)
					ELSE NULL
				END AS cid_new
			FROM bronze.erp_cust_az12
)
SELECT * FROM cte1
WHERE cid_new NOT IN (
					SELECT cst_key 
					FROM silver.crm_cust_info
				 )

-- new working query
SELECT
	CASE
		WHEN TRIM(cid) LIKE 'NAS%' THEN SUBSTRING(TRIM(cid) FROM 4)
		WHEN TRIM(cid) LIKE 'AW0%' THEN TRIM(cid)
		ELSE NULL
	END AS cid_new,
	bdate,
	gen
FROM bronze.erp_cust_az12;

-- =====================================================================================================================
-- bdate
-- identify max and min dates
-- explore records with null value

SELECT 'MAX BDATE' as BDATE, MAX(bdate)
FROM bronze.erp_cust_az12
UNION
SELECT 'MIN BDATE' as BDATE, MIN(bdate)
FROM bronze.erp_cust_az12;

--ISSUES:
--MAX date is 9999 which is not a valid year
--see bdate records in descending order to identify inaccurate dates

SELECT bdate
FROM bronze.erp_cust_az12
ORDER BY bdate DESC;

-- there are bdate with year 2038 up to 9999 which are invalid years.

--ACTION:
-- temporary solution is to turn dates greater than present to NULL. Use CURRENT_DATE function to get present date.

SELECT
	bdate,
	CASE
		WHEN bdate > CURRENT_DATE THEN NULL
		ELSE bdate
	END AS bdate_new
FROM bronze.erp_cust_az12
ORDER BY bdate DESC;

--new working query
SELECT
	CASE
		WHEN TRIM(cid) LIKE 'NAS%' THEN SUBSTRING(TRIM(cid) FROM 4)
		WHEN TRIM(cid) LIKE 'AW0%' THEN TRIM(cid)
		ELSE NULL
	END AS cid_new,
	CASE
		WHEN bdate > CURRENT_DATE THEN NULL
		ELSE bdate
	END AS bdate_new,
	gen
FROM bronze.erp_cust_az12;

-- =====================================================================================================================
-- gen
-- no trailing space
-- standardize values
-- check for NULLs
-- check for blanks

SELECT DISTINCT gen
FROM bronze.erp_cust_az12;

SELECT gen
FROM bronze.erp_cust_az12
WHERE TRIM(gen) != gen;

SELECT gen
FROM bronze.erp_cust_az12
WHERE gen IS NULL;

--ISSUES:
--NULL values
--there are trailing spaces
--multiple value with same meaning. M and Male, F and Female

--ACTION:
--NULL values to N/A
--M to Male, F to Female
--Remove trailing spaces using TRIM()

SELECT
	gen,
	CASE
		WHEN gen IS NULL OR TRIM(gen) = '' THEN 'N/A'
		WHEN UPPER(TRIM(gen)) = 'M' THEN 'Male'
		WHEN UPPER(TRIM(gen)) = 'F' THEN 'Female'
		ELSE INITCAP(TRIM(gen))
	END as gen_new
FROM bronze.erp_cust_az12
WHERE TRIM(gen) != gen OR gen IS NULL;

--To check the new script
WITH cte1 AS (
				SELECT
					CASE
						WHEN gen IS NULL OR TRIM(gen) = '' THEN 'N/A'
						WHEN UPPER(TRIM(gen)) = 'M' THEN 'Male'
						WHEN UPPER(TRIM(gen)) = 'F' THEN 'Female'
						ELSE INITCAP(TRIM(gen))
					END as gen_new
				FROM bronze.erp_cust_az12
)
SELECT DISTINCT * FROM cte1;

-- =====================================================================================================================
--new working query

SELECT
	CASE
		WHEN TRIM(cid) LIKE 'NAS%' THEN SUBSTRING(TRIM(cid) FROM 4)
		WHEN TRIM(cid) LIKE 'AW0%' THEN TRIM(cid)
		ELSE NULL
	END AS cid_new,
	CASE
		WHEN bdate > CURRENT_DATE THEN NULL
		ELSE bdate
	END AS bdate_new,
	CASE
		WHEN gen IS NULL OR TRIM(gen) = '' THEN 'N/A'
		WHEN UPPER(TRIM(gen)) = 'M' THEN 'Male'
		WHEN UPPER(TRIM(gen)) = 'F' THEN 'Female'
		ELSE INITCAP(TRIM(gen))
	END as gen_new
FROM bronze.erp_cust_az12;
--Insert the values that result from the query above into the silver.erp_cust_az12
