-- Data Quality Check of bronze.crm_cust_info
-- inspect all columns, identify what must be unique, what value must be standardized
-- identify primary key, see if it matches foreign key from referencing table.
-- identify if there are trailing spaces on text type columns
-- create script to fix issue per column

SELECT * FROM bronze.crm_cust_info;

-- cst_id
-- all value of cst_id must be unique
-- there must be no NULL values
SELECT cst_id, COUNT(*)
FROM bronze.crm_cust_info
GROUP BY cst_id
HAVING COUNT(*) > 1;

-- ISSUES:
-- There are 4 null values
-- There are 5 cst_id with duplicates

-- ACTION:
-- Identify which records with duplicate cst_id must be retained
-- cst_id with the latest cst_create_date must be retained
-- use window function
-- use WHERE clause to remove NULLs
SELECT
	cst_id, cst_create_date,
	ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS rownum
FROM bronze.crm_cust_info;

-- Script to remove duplicate and nulls in the cst_id
SELECT
	cst_id,
	cst_key,
	cst_firstname,
	cst_lastname,
	cst_marital_status,
	cst_gndr,
	cst_create_date
FROM (
	SELECT *,
	ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS rownum
	FROM bronze.crm_cust_info
)
WHERE
	rownum = 1 AND cst_id IS NOT NULL;


-- ====================================================================================================================
-- cst_key
-- all value of cst_key must be unique
-- there must be no NULL values

with cte1 AS (SELECT
	cst_id,
	cst_key,
	cst_firstname,
	cst_lastname,
	cst_marital_status,
	cst_gndr,
	cst_create_date
FROM (
	SELECT *,
	ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS rownum
	FROM bronze.crm_cust_info
)
WHERE
	rownum = 1 AND cst_id IS NOT NULL)

SELECT cst_key, COUNT(*) -- script for QCing cst_key column
FROM cte1
GROUP BY cst_key
HAVING COUNT(*) > 1 OR cst_key IS NULL;

-- ISSUES: NONE

-- ====================================================================================================================
-- cst_firstname, cst_lastname
-- no trailing spaces
-- check for capitalization

with cte1 AS (SELECT
	cst_id,
	cst_key,
	cst_firstname,
	cst_lastname,
	cst_marital_status,
	cst_gndr,
	cst_create_date
FROM (
	SELECT *,
	ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS rownum
	FROM bronze.crm_cust_info
)
WHERE
	rownum = 1 AND cst_id IS NOT NULL)

SELECT cst_firstname, TRIM(cst_firstname) AS trimmed
FROM cte1
WHERE cst_firstname != TRIM(cst_firstname);


-- for cst_lastname
with cte1 AS (SELECT
	cst_id,
	cst_key,
	cst_firstname,
	cst_lastname,
	cst_marital_status,
	cst_gndr,
	cst_create_date
FROM (
	SELECT *,
	ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS rownum
	FROM bronze.crm_cust_info
)
WHERE
	rownum = 1 AND cst_id IS NOT NULL)

SELECT cst_lastname, TRIM(cst_lastname) AS trimmed
FROM cte1
WHERE cst_lastname != TRIM(cst_lastname);

--ACTION:
-- USE TRIM() to remove trailing spaces
-- USE INITCAP() to standardize capitalization
SELECT
	cst_id,
	cst_key,
	INITCAP(TRIM(cst_firstname)) as cst_firstname_new,
	INITCAP(TRIM(cst_lastname)) as cst_lastname_new,
	cst_marital_status,
	cst_gndr,
	cst_create_date
FROM (
	SELECT *,
	ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS rownum
	FROM bronze.crm_cust_info
)
WHERE
	rownum = 1 AND cst_id IS NOT NULL;

-- ====================================================================================================================
-- cst_marital_status
-- no trailing spaces
-- check if values are standardized
-- check if there are blank or NULL values

WITH cte1 AS (SELECT
	cst_id,
	cst_key,
	INITCAP(TRIM(cst_firstname)) as cst_firstname_new,
	INITCAP(TRIM(cst_lastname)) as cst_lastname_new,
	cst_marital_status,
	cst_gndr,
	cst_create_date
FROM (
	SELECT *,
	ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS rownum
	FROM bronze.crm_cust_info
)
WHERE
	rownum = 1 AND cst_id IS NOT NULL)

--SELECT DISTINCT(cst_marital_status)
--FROM cte1;

SELECT cst_marital_status
FROM cte1
WHERE cst_marital_status != TRIM(cst_marital_status);

--ISSUES: NONE
--ACTION: 
--use TRIM() and UPPER() to ensure future data input will be standardized
--convert values: M to Married, S to Single, NULL to N/A
SELECT
	cst_id,
	cst_key,
	INITCAP(TRIM(cst_firstname)) as cst_firstname_new,
	INITCAP(TRIM(cst_lastname)) as cst_lastname_new,
	CASE 
		WHEN UPPER(TRIM(cst_marital_status)) = 'M' THEN 'Married'
		WHEN UPPER(TRIM(cst_marital_status)) = 'S' THEN 'Single'
		ELSE 'N/A'
	END as cst_marital_status_new,
	cst_gndr,
	cst_create_date
FROM (
	SELECT *,
	ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS rownum
	FROM bronze.crm_cust_info
)
WHERE
	rownum = 1 AND cst_id IS NOT NULL;


-- ====================================================================================================================
-- cst_gndr
-- no trailing spaces
-- check if values are standardized
-- check if there are blank or NULL values

WITH cte1 AS (SELECT
	cst_id,
	cst_key,
	INITCAP(TRIM(cst_firstname)) as cst_firstname_new,
	INITCAP(TRIM(cst_lastname)) as cst_lastname_new,
	CASE 
		WHEN UPPER(TRIM(cst_marital_status)) = 'M' THEN 'Married'
		WHEN UPPER(TRIM(cst_marital_status)) = 'S' THEN 'Single'
		ELSE 'N/A'
	END as cst_marital_status_new,
	cst_gndr,
	cst_create_date
FROM (
	SELECT *,
	ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS rownum
	FROM bronze.crm_cust_info
)
WHERE
	rownum = 1 AND cst_id IS NOT NULL)

SELECT DISTINCT(cst_gndr)
FROM cte1;

/*SELECT cst_gndr
FROM cte1
WHERE cst_gndr != TRIM(cst_gndr);*/

--ISSUE: there are NULL values
--ACTION: 
--replace NULL value with 'N/A' using CASE statement
--use TRIM() and UPPER() to ensure future data input will be standardized
SELECT
	cst_id,
	cst_key,
	INITCAP(TRIM(cst_firstname)) as cst_firstname_new,
	INITCAP(TRIM(cst_lastname)) as cst_lastname_new,
	CASE 
		WHEN UPPER(TRIM(cst_marital_status)) = 'M' THEN 'Married'
		WHEN UPPER(TRIM(cst_marital_status)) = 'S' THEN 'Single'
		ELSE 'N/A'
	END as cst_marital_status_new,
	CASE 
		WHEN UPPER(TRIM(cst_gndr)) = 'M' THEN 'Male'
		WHEN UPPER(TRIM(cst_gndr)) = 'F' THEN 'Female'
		ELSE 'N/A'
	END as cst_gndr_new,
	cst_create_date
FROM (
	SELECT *,
	ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS rownum
	FROM bronze.crm_cust_info
)
WHERE
	rownum = 1 AND cst_id IS NOT NULL;

-- Use the query above as values for the silver.crm_cust_info table
